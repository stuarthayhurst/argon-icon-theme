# This workflow will thoroughly test the build system (differential build, symlinks, index generator, cleaning, installing / uninstalling, full build)

name: Complete build system test

on:
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install build dependencies
      run: |
        # Add updated inkscape repository
        sudo add-apt-repository ppa:inkscape.dev/stable
        sudo apt install git inkscape make optipng
    - name: Check differential build works, and all files are committed
      run: |
        # Attempt to generate all changed icons (there shouldn't be any, as any build icons should've been committed)
        # Even if no icons are missing, this still provides a test for the build system
        make build -j$(nproc)
        # Fail if any files generated by last step that haven't been committed
        if [ ! -z "$(git status --porcelain)" ]; then exit 1; fi
    - name: Test all symlinks are valid
      run: |
        make check
    - name: Test index generator has no issues
      run: |
        make index
    - name: Test autoclean has no issues
      run: |
        make autoclean
    - name: Test icon theme installs and uninstalls without issue
      run: |
        sudo make install
        sudo make uninstall
    - name: Test clean has no issues
      run: |
        make clean
    - name: Test all icons build without failure
      run: |
        make regen -j$(nproc)
